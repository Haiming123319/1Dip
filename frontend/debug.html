<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMask Connection Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .status {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007cba;
        }
        .error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .success {
            border-left-color: #28a745;
            background: #f0fff4;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #005f8a;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” MetaMask Connection Debug Tool</h1>
    
    <div id="status" class="status">
        <h3>çŠ¶æ€æ£€æŸ¥</h3>
        <p>æ­£åœ¨æ£€æŸ¥...</p>
    </div>

    <button id="checkBtn">é‡æ–°æ£€æŸ¥</button>
    <button id="connectBtn" disabled>è¿æ¥MetaMask</button>
    <button id="testBtn" disabled>æµ‹è¯•åŠŸèƒ½</button>

    <div id="results"></div>

    <script>
        class MetaMaskDebugger {
            constructor() {
                this.provider = null;
                this.signer = null;
                this.account = null;
            }

            async init() {
                await this.runDiagnostics();
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('checkBtn').onclick = () => this.runDiagnostics();
                document.getElementById('connectBtn').onclick = () => this.connectWallet();
                document.getElementById('testBtn').onclick = () => this.testFunctionality();
            }

            async runDiagnostics() {
                const statusDiv = document.getElementById('status');
                const resultsDiv = document.getElementById('results');
                let html = '<h3>ğŸ“‹ è¯Šæ–­ç»“æœ</h3>';

                try {
                    // 1. æ£€æŸ¥MetaMaskæ˜¯å¦å®‰è£…
                    if (typeof window.ethereum === 'undefined') {
                        html += '<div class="status error">âŒ MetaMaskæœªå®‰è£…</div>';
                        html += '<p>è¯·å®‰è£…MetaMaskæµè§ˆå™¨æ‰©å±•: <a href="https://metamask.io" target="_blank">https://metamask.io</a></p>';
                        statusDiv.innerHTML = html;
                        return;
                    }
                    html += '<div class="status success">âœ… MetaMaskå·²å®‰è£…</div>';

                    // 2. æ£€æŸ¥ethers.js
                    if (typeof ethers === 'undefined') {
                        html += '<div class="status error">âŒ Ethers.jsæœªåŠ è½½</div>';
                    } else {
                        html += '<div class="status success">âœ… Ethers.jså·²åŠ è½½ (ç‰ˆæœ¬: ' + ethers.version + ')</div>';
                    }

                    // 3. æ£€æŸ¥å½“å‰è¿æ¥çŠ¶æ€
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts.length > 0) {
                            html += '<div class="status success">âœ… é’±åŒ…å·²è¿æ¥: ' + accounts[0] + '</div>';
                            document.getElementById('connectBtn').textContent = 'å·²è¿æ¥';
                            document.getElementById('testBtn').disabled = false;
                            this.account = accounts[0];
                        } else {
                            html += '<div class="status">âš ï¸ é’±åŒ…æœªè¿æ¥</div>';
                            document.getElementById('connectBtn').disabled = false;
                        }
                    } catch (error) {
                        html += '<div class="status error">âŒ æ£€æŸ¥è¿æ¥çŠ¶æ€å¤±è´¥: ' + error.message + '</div>';
                    }

                    // 4. æ£€æŸ¥ç½‘ç»œ
                    try {
                        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                        const networkNames = {
                            '0x1': 'Ethereum Mainnet',
                            '0x5': 'Goerli Testnet',
                            '0xaa36a7': 'Sepolia Testnet',
                            '0x89': 'Polygon Mainnet'
                        };
                        const networkName = networkNames[chainId] || `æœªçŸ¥ç½‘ç»œ (${chainId})`;
                        html += '<div class="status">ğŸŒ å½“å‰ç½‘ç»œ: ' + networkName + '</div>';
                    } catch (error) {
                        html += '<div class="status error">âŒ è·å–ç½‘ç»œä¿¡æ¯å¤±è´¥: ' + error.message + '</div>';
                    }

                    // 5. æ£€æŸ¥æƒé™
                    try {
                        const permissions = await window.ethereum.request({
                            method: 'wallet_getPermissions'
                        });
                        html += '<div class="status">ğŸ” æƒé™æ•°é‡: ' + permissions.length + '</div>';
                    } catch (error) {
                        html += '<div class="status">ğŸ” æƒé™æ£€æŸ¥: ä¸æ”¯æŒæˆ–å‡ºé”™</div>';
                    }

                    resultsDiv.innerHTML = html;

                } catch (error) {
                    statusDiv.innerHTML = '<div class="status error">âŒ è¯Šæ–­è¿‡ç¨‹å‡ºé”™: ' + error.message + '</div>';
                }
            }

            async connectWallet() {
                try {
                    console.log('ğŸ”— å¼€å§‹è¿æ¥MetaMask...');
                    
                    const accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });

                    if (accounts.length === 0) {
                        throw new Error('ç”¨æˆ·æ‹’ç»è¿æ¥');
                    }

                    this.account = accounts[0];
                    this.provider = new ethers.providers.Web3Provider(window.ethereum);
                    this.signer = this.provider.getSigner();

                    console.log('âœ… è¿æ¥æˆåŠŸ!', this.account);
                    
                    document.getElementById('connectBtn').textContent = 'å·²è¿æ¥: ' + this.account.slice(0, 6) + '...' + this.account.slice(-4);
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('testBtn').disabled = false;

                    await this.runDiagnostics();

                } catch (error) {
                    console.error('âŒ è¿æ¥å¤±è´¥:', error);
                    alert('è¿æ¥å¤±è´¥: ' + error.message);
                }
            }

            async testFunctionality() {
                if (!this.provider || !this.signer) {
                    alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                    return;
                }

                try {
                    // æµ‹è¯•è·å–ä½™é¢
                    const balance = await this.provider.getBalance(this.account);
                    const balanceInEth = ethers.utils.formatEther(balance);
                    
                    // æµ‹è¯•è·å–ç½‘ç»œä¿¡æ¯
                    const network = await this.provider.getNetwork();
                    
                    // æµ‹è¯•ç­¾å
                    const message = "DRManager Test Message";
                    const signature = await this.signer.signMessage(message);

                    const results = `
                        <div class="status success">
                            <h4>ğŸ§ª åŠŸèƒ½æµ‹è¯•ç»“æœ</h4>
                            <div class="code">
                                è´¦æˆ·: ${this.account}<br>
                                ä½™é¢: ${balanceInEth} ETH<br>
                                ç½‘ç»œ: ${network.name} (Chain ID: ${network.chainId})<br>
                                ç­¾åæµ‹è¯•: æˆåŠŸ<br>
                                ç­¾åé•¿åº¦: ${signature.length} å­—ç¬¦
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('results').innerHTML += results;
                    
                } catch (error) {
                    document.getElementById('results').innerHTML += `
                        <div class="status error">
                            <h4>âŒ åŠŸèƒ½æµ‹è¯•å¤±è´¥</h4>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        const debugger = new MetaMaskDebugger();
        document.addEventListener('DOMContentLoaded', () => {
            debugger.init();
        });
    </script>
</body>
</html> 