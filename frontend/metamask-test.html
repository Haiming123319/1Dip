<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMask ç®€å•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #ccc;
        }
        .success { background: #d4edda; border-left-color: #28a745; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        .info { background: #d1ecf1; border-left-color: #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ¦Š MetaMask ç®€å•è¿æ¥æµ‹è¯•</h1>
    
    <div id="status"></div>
    
    <button id="checkBtn">æ£€æŸ¥MetaMask</button>
    <button id="connectBtn" disabled>è¿æ¥é’±åŒ…</button>
    <button id="clearBtn">æ¸…é™¤æ—¥å¿—</button>
    
    <div id="log"></div>

    <script>
        class SimpleMetaMaskTest {
            constructor() {
                this.log = document.getElementById('log');
                this.status = document.getElementById('status');
                this.setupButtons();
                this.addLog('é¡µé¢åŠ è½½å®Œæˆ', 'info');
                this.checkMetaMask();
            }

            setupButtons() {
                document.getElementById('checkBtn').onclick = () => this.checkMetaMask();
                document.getElementById('connectBtn').onclick = () => this.connectWallet();
                document.getElementById('clearBtn').onclick = () => this.clearLog();
            }

            addLog(message, type = 'info') {
                const div = document.createElement('div');
                div.className = `status ${type}`;
                div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
                this.log.appendChild(div);
                this.log.scrollTop = this.log.scrollHeight;
                console.log(`[${type.toUpperCase()}] ${message}`);
            }

            clearLog() {
                this.log.innerHTML = '';
            }

            async checkMetaMask() {
                this.addLog('å¼€å§‹æ£€æŸ¥MetaMask...', 'info');
                
                // 1. æ£€æŸ¥window.ethereumæ˜¯å¦å­˜åœ¨
                if (typeof window.ethereum === 'undefined') {
                    this.addLog('âŒ window.ethereum æœªæ‰¾åˆ°', 'error');
                    this.addLog('è¯·ç¡®ä¿å·²å®‰è£…MetaMaskæ‰©å±•å¹¶åˆ·æ–°é¡µé¢', 'warning');
                    this.status.innerHTML = '<div class="status error">âŒ MetaMaskæœªå®‰è£…æˆ–æœªåŠ è½½</div>';
                    return;
                }
                
                this.addLog('âœ… window.ethereum å·²æ‰¾åˆ°', 'success');
                
                // 2. æ£€æŸ¥æ˜¯å¦æ˜¯MetaMask
                if (window.ethereum.isMetaMask) {
                    this.addLog('âœ… ç¡®è®¤æ˜¯MetaMaské’±åŒ…', 'success');
                } else {
                    this.addLog('âš ï¸ å¯èƒ½ä¸æ˜¯MetaMaské’±åŒ…', 'warning');
                }
                
                // 3. æ£€æŸ¥å½“å‰è¿æ¥çŠ¶æ€
                try {
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_accounts' 
                    });
                    
                    if (accounts.length > 0) {
                        this.addLog(`âœ… å·²è¿æ¥è´¦æˆ·: ${accounts[0]}`, 'success');
                        document.getElementById('connectBtn').textContent = 'å·²è¿æ¥';
                        document.getElementById('connectBtn').disabled = true;
                    } else {
                        this.addLog('â„¹ï¸ æœªè¿æ¥ä»»ä½•è´¦æˆ·', 'info');
                        document.getElementById('connectBtn').disabled = false;
                    }
                } catch (error) {
                    this.addLog(`âŒ æ£€æŸ¥è´¦æˆ·å¤±è´¥: ${error.message}`, 'error');
                }
                
                // 4. æ£€æŸ¥ç½‘ç»œ
                try {
                    const chainId = await window.ethereum.request({ 
                        method: 'eth_chainId' 
                    });
                    const networks = {
                        '0x1': 'Ethereum ä¸»ç½‘',
                        '0x5': 'Goerli æµ‹è¯•ç½‘',
                        '0xaa36a7': 'Sepolia æµ‹è¯•ç½‘',
                        '0x89': 'Polygon ä¸»ç½‘'
                    };
                    const networkName = networks[chainId] || `æœªçŸ¥ç½‘ç»œ (${chainId})`;
                    this.addLog(`ğŸŒ å½“å‰ç½‘ç»œ: ${networkName}`, 'info');
                } catch (error) {
                    this.addLog(`âŒ è·å–ç½‘ç»œå¤±è´¥: ${error.message}`, 'error');
                }
                
                this.status.innerHTML = '<div class="status success">âœ… MetaMaskæ£€æŸ¥å®Œæˆ</div>';
            }

            async connectWallet() {
                this.addLog('å¼€å§‹è¿æ¥é’±åŒ…...', 'info');
                
                try {
                    if (typeof window.ethereum === 'undefined') {
                        throw new Error('MetaMaskæœªå®‰è£…');
                    }
                    
                    this.addLog('å‘é€è¿æ¥è¯·æ±‚...', 'info');
                    const accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });
                    
                    if (accounts.length === 0) {
                        throw new Error('æœªè·å–åˆ°è´¦æˆ·');
                    }
                    
                    const account = accounts[0];
                    this.addLog(`âœ… è¿æ¥æˆåŠŸï¼è´¦æˆ·: ${account}`, 'success');
                    
                    // æµ‹è¯•åŸºæœ¬åŠŸèƒ½
                    this.addLog('æµ‹è¯•åŸºæœ¬åŠŸèƒ½...', 'info');
                    
                    // è·å–ä½™é¢
                    try {
                        const balance = await window.ethereum.request({
                            method: 'eth_getBalance',
                            params: [account, 'latest']
                        });
                        const balanceInEth = parseInt(balance, 16) / Math.pow(10, 18);
                        this.addLog(`ğŸ’° è´¦æˆ·ä½™é¢: ${balanceInEth.toFixed(4)} ETH`, 'info');
                    } catch (error) {
                        this.addLog(`âš ï¸ è·å–ä½™é¢å¤±è´¥: ${error.message}`, 'warning');
                    }
                    
                    document.getElementById('connectBtn').textContent = 'å·²è¿æ¥: ' + account.slice(0, 6) + '...';
                    document.getElementById('connectBtn').disabled = true;
                    
                    this.status.innerHTML = '<div class="status success">âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼</div>';
                    
                } catch (error) {
                    this.addLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    
                    let errorMessage = 'è¿æ¥å¤±è´¥';
                    if (error.code === 4001) {
                        errorMessage = 'ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚';
                    } else if (error.code === -32002) {
                        errorMessage = 'è¿æ¥è¯·æ±‚å·²åœ¨å¤„ç†ä¸­ï¼Œè¯·æŸ¥çœ‹MetaMask';
                    }
                    
                    this.status.innerHTML = `<div class="status error">âŒ ${errorMessage}</div>`;
                }
            }
        }

        // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
        window.addEventListener('load', () => {
            // ç»™MetaMaskä¸€äº›æ—¶é—´æ³¨å…¥
            setTimeout(() => {
                new SimpleMetaMaskTest();
            }, 500);
        });
    </script>
</body>
</html> 